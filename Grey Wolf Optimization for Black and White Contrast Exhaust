#Black and White Contrast Exhaust
import cv2
import numpy as np
import random
import math

# =========================
# Fitness Function
# =========================
def image_fitness(img):
    hist = cv2.calcHist([img],[0],None,[256],[0,256])
    hist_norm = hist.ravel()/hist.sum()
    entropy = -np.sum(hist_norm*np.log2(hist_norm+1e-7))
    std = np.std(img)
    return entropy + std

# =========================
# Apply Gamma Correction
# =========================
def apply_gamma(img, gamma):
    corrected = np.power(img/255.0, gamma)
    corrected = np.uint8(corrected*255)
    return corrected

# =========================
# Grey Wolf Optimizer
# =========================
def gwo_contrast(img, wolves=8, iterations=20):
    if img is None:
        raise ValueError("Image not loaded! Check file path or name.")

    lb, ub = 0.1, 3.0
    population = np.random.uniform(lb, ub, wolves)

    def fit(g): return image_fitness(apply_gamma(img, g))

    fitness = np.array([fit(g) for g in population])

    alpha = beta = delta = None
    alpha_f = beta_f = delta_f = -np.inf

    for t in range(iterations):
        a = 2 * (1 - t / iterations)

        for i in range(wolves):
            r1, r2 = random.random(), random.random()
            A1 = 2*a*r1 - a
            C1 = 2*r2

            r1, r2 = random.random(), random.random()
            A2 = 2*a*r1 - a
            C2 = 2*r2

            r1, r2 = random.random(), random.random()
            A3 = 2*a*r1 - a
            C3 = 2*r2

            if alpha is not None:
                X1 = alpha - A1 * abs(C1*alpha - population[i])
                X2 = beta  - A2 * abs(C2*beta  - population[i])
                X3 = delta - A3 * abs(C3*delta - population[i])

                population[i] = np.clip((X1+X2+X3)/3, lb, ub)

            new_fit = fit(population[i])

            if new_fit > alpha_f:
                delta, delta_f = beta, beta_f
                beta, beta_f = alpha, alpha_f
                alpha, alpha_f = population[i], new_fit
            elif new_fit > beta_f:
                delta, delta_f = beta, beta_f
                beta, beta_f = population[i], new_fit
            elif new_fit > delta_f:
                delta, delta_f = population[i], new_fit

        print(f"Iteration {t+1}/{iterations} | Best gamma = {round(alpha,4)} | Fitness = {round(alpha_f,4)}")

    return apply_gamma(img, alpha), alpha

# =========================
# LOAD IMAGE SAFELY
# =========================
path = "image.jpg"  # ğŸ” Change this if needed
img = cv2.imread(path, 0)

if img is None:
    print(f"âŒ Could not load image: {path}")
    print("ğŸ‘‰ Fix: place image in same folder or give full path, e.g.")
    print('img = cv2.imread("/content/drive/MyDrive/image.jpg", 0)')
else:
    enhanced, best_gamma = gwo_contrast(img)
    print("\nOptimal Gamma:", best_gamma)
    cv2.imwrite("enhanced_gwo.png", enhanced)
    print("Enhanced image saved as enhanced_gwo.png")
